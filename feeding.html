<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feeding Calculator — Pet Scan</title>
  <!-- 站点样式（已包含短款深色下拉 .lang-select 等） -->
  <link rel="stylesheet" href="../assets/site.css" />
  <!-- 可选：匿名统计（自动使用当前域名；如不需要可删除） -->
  <script defer data-domain="" src="https://plausible.io/js/script.js"></script>
</head>
<body>

  <!-- 顶部导航（相对路径从 feeding/ 出发） -->
  <header class="topbar">
    <nav class="nav">
      <a href="../index.html" data-i18n="nav.home">Home</a>
      <a href="./feeding.html" data-i18n="nav.calculator">Calculator</a>
      <a href="../cards/transition-7.html" data-i18n="nav.transition7">7-Day Switch</a>
      <a href="../feedback.html" data-i18n="nav.feedback">Feedback</a>
    </nav>

    <!-- 语言下拉（短款深色，始终保留当前 lang） -->
    <select id="langSelect" class="lang-select" aria-label="Language">
      <option value="en">English</option>
      <option value="es">Español</option>
      <option value="zh">中文</option>
      <option value="fr">Français</option>
    </select>
  </header>

  <main class="container">
    <section class="hero">
      <h1 data-i18n="feeding.title">Feeding Calculator</h1>
      <p class="small" data-i18n="legal.info_boundary">
        Informational only. Not medical advice.
      </p>
    </section>

    <!-- 计算器卡片（两列网格布局，移动端自动一列） -->
    <section class="card">
      <div class="grid">
        <label>
          <span data-i18n="feeding.pet_type.label">Pet</span>
          <select id="petType">
            <option value="dog" data-i18n="feeding.pet_type.dog">Dog</option>
            <option value="cat" data-i18n="feeding.pet_type.cat">Cat</option>
          </select>
        </label>

        <label>
          <span data-i18n="feeding.weight.label">Weight</span>
          <input id="weight" type="number" step="0.01" min="0" placeholder="Enter weight"
                 data-i18n-placeholder="feeding.weight.placeholder" />
        </label>

        <label>
          <span data-i18n="feeding.unit.label">Unit</span>
          <select id="unit">
            <option value="kg" data-i18n="feeding.unit.kg">kg</option>
            <option value="lb" data-i18n="feeding.unit.lb">lb</option>
          </select>
        </label>

        <label>
          <span data-i18n="feeding.activity.label">Activity</span>
          <select id="activity">
            <option value="resting" data-i18n="feeding.activity.resting">Resting</option>
            <option value="normal"  data-i18n="feeding.activity.normal">Normal</option>
            <option value="active"  data-i18n="feeding.activity.active">Active</option>
          </select>
        </label>

        <label>
          <span data-i18n="feeding.kcal_per_cup.label">kcal per cup</span>
          <input id="kcalPerCup" type="number" step="1" min="1" value="350" />
        </label>

        <label>
          <span data-i18n="feeding.grams_per_cup.label">grams per cup</span>
          <input id="gramsPerCup" type="number" step="1" min="1" value="110" />
        </label>
      </div>

      <div class="cta-row">
        <button id="calcBtn" class="btn" data-i18n="feeding.calculate">Calculate</button>
      </div>

      <hr />

      <div class="panel" id="resultPanel" hidden>
        <h3 data-i18n="feeding.result.title">Result</h3>
        <p id="resultText"></p>
      </div>

      <p class="small" style="margin-top:12px">
        <span data-i18n="feeding.formula.note">RER = 70 × weight^0.75; MER = RER × activity factor.</span>
      </p>
    </section>
  </main>

  <!-- ========== 语言与导航修复（核心：无“??%3F”） ========== -->
  <script>
    (function () {
      const ALLOWED = ["en", "es", "zh", "fr"];
      function getLang() {
        const u = new URL(location.href);
        let lang = (u.searchParams.get("lang") || localStorage.getItem("ps.lang") || "en").toLowerCase();
        if (!ALLOWED.includes(lang)) lang = "en";
        return lang;
      }
      function setLang(lang) {
        if (!ALLOWED.includes(lang)) lang = "en";
        // 1) 写入本页 URL（不会产生 ?? 或 %3F）
        const u = new URL(location.href);
        u.searchParams.set("lang", lang);
        if (u.toString() !== location.href) history.replaceState(null, "", u);
        // 2) 写入本地存储
        localStorage.setItem("ps.lang", lang);
        // 3) 同步下拉选项
        const sel = document.getElementById("langSelect");
        if (sel && sel.value !== lang) sel.value = lang;
        // 4) 给站内链接补齐/替换 lang（相对或绝对均可，无重复 ?）
        document.querySelectorAll('a[href$=".html"], a[href$=".htm"]').forEach(a => {
          try {
            const url = new URL(a.getAttribute("href"), location.href);
            // 只改站内 .html 目标
            if (!/\.html?$/.test(url.pathname)) return;
            url.searchParams.set("lang", lang);
            // 用相对于当前站点根的绝对路径，避免子目录相对路径拼接出错
            a.setAttribute("href", url.pathname + "?" + url.searchParams.toString());
          } catch (e) { /* ignore */ }
        });
        // 5) 调用页面内简易 i18n（仅本页用到的键）
        applyI18n(lang);
      }

      // ——最小 i18n（只覆盖本页需要的文案），不依赖外部脚本——
      const I18N = {
        en: {
          "nav.home":"Home","nav.calculator":"Calculator","nav.transition7":"7-Day Switch","nav.feedback":"Feedback",
          "feeding.title":"Feeding Calculator",
          "legal.info_boundary":"Informational only. Not medical advice.",
          "feeding.pet_type.label":"Pet","feeding.pet_type.dog":"Dog","feeding.pet_type.cat":"Cat",
          "feeding.weight.label":"Weight","feeding.weight.placeholder":"Enter weight",
          "feeding.unit.label":"Unit","feeding.unit.kg":"kg","feeding.unit.lb":"lb",
          "feeding.activity.label":"Activity","feeding.activity.resting":"Resting","feeding.activity.normal":"Normal","feeding.activity.active":"Active",
          "feeding.kcal_per_cup.label":"kcal per cup","feeding.grams_per_cup.label":"grams per cup",
          "feeding.calculate":"Calculate","feeding.result.title":"Result",
          "feeding.formula.note":"RER = 70 × weight^0.75; MER = RER × activity factor."
        },
        es: {
          "nav.home":"Inicio","nav.calculator":"Calculadora","nav.transition7":"Cambio 7 días","nav.feedback":"Comentarios",
          "feeding.title":"Calculadora de alimentación",
          "legal.info_boundary":"Solo informativo. No es consejo médico.",
          "feeding.pet_type.label":"Mascota","feeding.pet_type.dog":"Perro","feeding.pet_type.cat":"Gato",
          "feeding.weight.label":"Peso","feeding.weight.placeholder":"Ingrese el peso",
          "feeding.unit.label":"Unidad","feeding.unit.kg":"kg","feeding.unit.lb":"lb",
          "feeding.activity.label":"Actividad","feeding.activity.resting":"Reposo","feeding.activity.normal":"Normal","feeding.activity.active":"Activo",
          "feeding.kcal_per_cup.label":"kcal por taza","feeding.grams_per_cup.label":"gramos por taza",
          "feeding.calculate":"Calcular","feeding.result.title":"Resultado",
          "feeding.formula.note":"RER = 70 × peso^0.75; MER = RER × factor de actividad."
        },
        zh: {
          "nav.home":"首页","nav.calculator":"喂食计算器","nav.transition7":"7天换粮","nav.feedback":"反馈",
          "feeding.title":"喂食计算器",
          "legal.info_boundary":"仅供信息参考；不构成医疗建议。",
          "feeding.pet_type.label":"宠物","feeding.pet_type.dog":"犬","feeding.pet_type.cat":"猫",
          "feeding.weight.label":"体重","feeding.weight.placeholder":"输入体重",
          "feeding.unit.label":"单位","feeding.unit.kg":"千克","feeding.unit.lb":"磅",
          "feeding.activity.label":"活动水平","feeding.activity.resting":"静息","feeding.activity.normal":"日常","feeding.activity.active":"活跃",
          "feeding.kcal_per_cup.label":"每杯千卡","feeding.grams_per_cup.label":"每杯克重",
          "feeding.calculate":"计算","feeding.result.title":"结果",
          "feeding.formula.note":"RER = 70 × 体重^0.75；MER = RER × 活动因子。"
        },
        fr: {
          "nav.home":"Accueil","nav.calculator":"Calculateur","nav.transition7":"Transition 7 jours","nav.feedback":"Retour",
          "feeding.title":"Calculateur d’alimentation",
          "legal.info_boundary":"À titre informatif uniquement. Pas un avis médical.",
          "feeding.pet_type.label":"Animal","feeding.pet_type.dog":"Chien","feeding.pet_type.cat":"Chat",
          "feeding.weight.label":"Poids","feeding.weight.placeholder":"Saisir le poids",
          "feeding.unit.label":"Unité","feeding.unit.kg":"kg","feeding.unit.lb":"lb",
          "feeding.activity.label":"Activité","feeding.activity.resting":"Repos","feeding.activity.normal":"Normal","feeding.activity.active":"Actif",
          "feeding.kcal_per_cup.label":"kcal par cup","feeding.grams_per_cup.label":"grammes par cup",
          "feeding.calculate":"Calculer","feeding.result.title":"Résultat",
          "feeding.formula.note":"RER = 70 × poids^0.75 ; MER = RER × facteur d’activité."
        }
      };

      function applyI18n(lang){
        const dict = I18N[lang] || I18N.en;
        // text
        document.querySelectorAll("[data-i18n]").forEach(el=>{
          const key = el.getAttribute("data-i18n");
          if (dict[key]) el.textContent = dict[key];
        });
        // placeholder
        document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
          const key = el.getAttribute("data-i18n-placeholder");
          if (dict[key]) el.setAttribute("placeholder", dict[key]);
        });
      }

      // 初始化：读 lang、渲染、改链接
      const initLang = getLang();
      setLang(initLang);

      // 下拉变化 => 切换语言 + 改链接
      const selectEl = document.getElementById("langSelect");
      if (selectEl){
        selectEl.value = initLang;
        selectEl.addEventListener("change", e => setLang(e.target.value));
      }

      // 对外暴露（可被其他脚本复用）
      window.__setLang = setLang;
      window.__getLang = getLang;
    })();
  </script>

  <!-- ========== 计算器逻辑（保留并加固） ========== -->
  <script>
    (function(){
      const $ = sel => document.querySelector(sel);

      function lbToKg(lb){ return lb * 0.45359237 }
      function pow075(x){ return Math.pow(x, 0.75) }

      // 活动因子：尽量保持与你现有逻辑一致（可按需微调）
      function activityFactor(pet, level){
        // 常用区间：静息 1.2~1.6 / 日常 1.6~2.0 / 活跃 2.0~3.0
        const base = {
          resting: pet === "cat" ? 1.2 : 1.6,
          normal:  pet === "cat" ? 1.4 : 1.8,
          active:  pet === "cat" ? 1.6 : 2.2
        };
        return base[level] || base.normal;
      }

      function calc(){
        const pet = $("#petType").value;
        const unit = $("#unit").value;
        const activity = $("#activity").value;

        let w = parseFloat($("#weight").value);
        if (!(w > 0)) { alert("Please enter valid weight."); return; }
        if (unit === "lb") w = lbToKg(w);

        const kcalPerCup = Math.max(1, parseFloat($("#kcalPerCup").value)||0);
        const gramsPerCup = Math.max(1, parseFloat($("#gramsPerCup").value)||0);

        // RER & MER
        const RER = 70 * pow075(w);
        const AF  = activityFactor(pet, activity);
        const MER = RER * AF;

        // 换算到杯/克
        const cupsPerDay  = MER / kcalPerCup;
        const gramsPerDay = cupsPerDay * gramsPerCup;

        const lang = (window.__getLang && __getLang()) || "en";
        const fmt = new Intl.NumberFormat(lang, { maximumFractionDigits: 1 });

        const lines = [
          `RER: ${fmt.format(RER)} kcal/day`,
          `MER: ${fmt.format(MER)} kcal/day`,
          `≈ ${fmt.format(cupsPerDay)} cup/day`,
          `≈ ${fmt.format(gramsPerDay)} g/day`
        ];

        $("#resultText").textContent = lines.join(" · ");
        $("#resultPanel").hidden = false;

        // 可选：埋点
        try { window.plausible && window.plausible("calc_click"); } catch(e){}
      }

      $("#calcBtn").addEventListener("click", calc);
    })();
  </script>
</body>
</html>

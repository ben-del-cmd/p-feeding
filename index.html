<!-- deploy: 2025-10-06 · feature-20251006-urlshare+print (kg/lb + URL state + print) -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pet A Plan · Feeding & Switch Helper (v1.2.3 hotfix)</title>
<meta name="description" content="Scan → unify terms → feeding calc → 7-day switch tips. Informational only; not medical advice." />
<meta name="referrer" content="strict-origin-when-cross-origin" />
<meta name="theme-color" content="#0b1220" />
<meta http-equiv="x-ua-compatible" content="IE=edge" />
<link rel="icon" href="data:," />
<style>
:root{--bg:#0b1220;--fg:#e8eefc;--muted:#9fb0d0;--card:#111a2e;--accent:#7aa7ff;--maxw:980px}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--fg)}
a{color:var(--accent)}
.wrap{max-width:var(--maxw);margin:0 auto;padding:16px 20px 80px}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,18,32,.95),rgba(11,18,32,.75));backdrop-filter:saturate(140%) blur(8px);z-index:10;border-bottom:1px solid #1f2b44}
.bar{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:var(--maxw);margin:0 auto;padding:10px 16px}
.brand{display:flex;gap:10px;align-items:center;white-space:nowrap}
.brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
nav{display:flex;gap:8px;flex:1 1 auto;justify-content:flex-start;flex-wrap:nowrap;min-width:0}
nav a{padding:6px 10px;border-radius:10px;text-decoration:none;border:1px solid #24324f;color:var(--fg);white-space:nowrap}
nav a.active{background:#16213a}
.langbox{flex:0 0 auto;display:flex;align-items:center;gap:8px}
.langbox select{background:#0f1930;border:1px solid #24324f;color:var(--fg);border-radius:10px;padding:8px 10px;min-width:160px}
select,input,button{background:#0f1930;border:1px solid #24324f;color:var(--fg);border-radius:10px;padding:8px 10px}
button.primary{background:#17305f;border-color:#2c4d8a}
input[type=number]{width:100%}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
.card{background:var(--card);border:1px solid #1c2740;border-radius:16px;padding:16px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.row > *{flex:1 1 140px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.muted{color:var(--muted)}
.footer{opacity:.9;font-size:.9em}
hr{border:none;border-top:1px solid #1f2b44;margin:10px 0}
.hint{font-size:.9em}
.label-inline{display:flex;align-items:center;gap:8px}

/* ===== Scoped form fixes (#calc) ===== */
#calc .form-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(220px, 1fr));
  gap:14px 16px;
  justify-items:start;
  align-items:end;
}
#calc .form-grid > *{display:flex;flex-direction:column;gap:6px;min-width:0}
#calc input,#calc select,#calc textarea{width:min(100%, 360px)}
#calc .factor-row{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px 14px;
}
/* factor card radio：更贴近文字、更紧凑（视觉微调） */
#calc .factor-row .label-inline{
  display:grid;
  grid-template-columns:auto 1fr;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  background:#0f1930;border:1px solid #24324f;border-radius:12px;
}
#calc .factor-row input[type="radio"]{margin:0;transform:translateY(-1px)}
#calc .factor-row .label-inline > span{line-height:1.15}

/* weight unit combo */
.weight-line{display:flex;gap:8px;align-items:center}
.weight-line input{flex:1}
.weight-line select{width:80px}

/* 7-Day 单列 */
#switch .grid{grid-template-columns:1fr}

/* ===== Print layout for 7-Day ===== */
@media print{
  @page{size:A4;margin:14mm}
  body{background:#fff;color:#000}
  header,.route:not(#switch){display:none!important}
  #switch{display:block!important}
  #switch .card{border:none;padding:0}
  #switch h2{margin:0 0 8px 0;color:#000}
  #switch .grid{grid-template-columns:repeat(2,1fr);gap:8px}
  #switch .grid .card{border:1px solid #ddd;border-radius:8px;padding:10px}
  .print-note{display:block!important;color:#000;margin-bottom:8px}
}
.print-note{display:none}
@media (min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand" aria-label="Pet A Plan">
      <div class="dot"></div>
      <strong>Pet A Plan</strong>
      <span class="muted" id="version">v1.2.3 hotfix</span>
    </div>
    <nav aria-label="Primary">
      <a href="#home" data-i18n="nav.home" class="active">Home</a>
      <a href="#calc" data-i18n="nav.calc">Calc</a>
      <a href="#switch" data-i18n="nav.switch">7-Day</a>
      <a href="#feedback" data-i18n="nav.feedback">Feedback</a>
    </nav>
    <div class="langbox" aria-label="Language">
      <button id="resetSaved" class="primary" style="display:none">Reset saved</button>
      <select id="langSel" aria-label="Language">
        <option value="en">English</option>
        <option value="zh">简体中文</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section id="home" class="route">
    <div class="grid">
      <div class="card">
        <h2 data-i18n="home.title">Feeding & Switch Helper</h2>
        <p class="muted" data-i18n="home.pitch">Informational tool for the U.S. market: turn pet food / grooming labels into actionable guidance. Not medical advice.</p>
        <div class="grid">
          <div class="card">
            <div class="muted" data-i18n="home.kcal">RER/MER transparent</div>
            <div class="mono">RER = 70 × kg^0.75</div>
          </div>
          <div class="card">
            <div class="muted" data-i18n="home.i18n">Multi-language</div>
            <div class="mono">en / zh / es / fr</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 data-i18n="home.quick">Quick start</h3>
        <ol>
          <li data-i18n="home.q1">Go to Calc → enter weight (kg) → pick species & activity factor.</li>
          <li data-i18n="home.q2">Review kcal/day and grams/day. Cups/day requires density info from the bag.</li>
          <li data-i18n="home.q3">See 7-Day gradual switch plan. If stool soft or upset → hold or step back.</li>
        </ol>
      </div>
    </div>
  </section>

  <!-- CALC -->
  <section id="calc" class="route" hidden>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <h2 data-i18n="calc.title" style="margin:0">Feeding Calculator</h2>
        <small id="resetSavedLink" style="cursor:pointer;text-decoration:underline" data-i18n="ui.reset">Reset saved</small>
      </div>

      <div class="form-grid">
        <div>
          <label for="species" data-i18n="calc.species">Species</label>
          <select id="species" aria-label="Species">
            <option value="dog">Dog</option>
            <option value="cat">Cat</option>
          </select>
        </div>
        <div>
          <label for="wkg" data-i18n="calc.weight">Weight (kg)</label>
          <div class="weight-line">
            <input id="wkg" type="number" min="0" step="0.1" placeholder="10" />
            <select id="wUnit" aria-label="unit">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
          </div>
        </div>
        <div>
          <label for="lifeStageLbl" data-i18n="calc.lifeStage">Life stage</label>
          <select id="lifeStageLbl">
            <option value="puppy">Puppy / Kitten</option>
            <option value="adult" selected>Adult</option>
            <option value="senior">Senior</option>
          </select>
        </div>
      </div>

      <div style="height:8px"></div>

      <fieldset class="card" style="padding:12px">
        <legend data-i18n="calc.activity">Activity / life stage (MER factor)</legend>

        <div id="factors" class="factor-row" role="radiogroup" aria-label="MER factor"></div>

        <p class="muted" data-i18n="calc.factorHint">Labels show the actual factor used.</p>
        <p class="hint muted" data-i18n="calc.infoTip">Info (i): RER=70×kg^0.75; MER=RER×factor. Factors are a starting point—adjust by body condition & stool; special stages/diseases: follow your vet.</p>

        <div class="row">
          <label class="label-inline"><input type="checkbox" id="useCustom"/> <span data-i18n="calc.customToggle">Use custom factor</span></label>
          <input id="customFactor" type="number" min="0.8" max="6" step="0.1" placeholder="1.6" disabled />
        </div>
        <p class="hint muted" data-i18n="calc.customHint">Only change if you know what you’re doing (懂则改，不懂别动)。</p>
      </fieldset>

      <div style="height:8px"></div>

      <fieldset class="card" style="padding:12px">
        <legend data-i18n="calc.density">Optional: density for precise grams/cups</legend>

        <div class="form-grid">
          <div>
            <label for="kcal100" data-i18n="calc.kcal100">kcal / 100 g</label>
            <input id="kcal100" type="number" min="1" step="1" placeholder="350" />
          </div>
          <div>
            <label for="kcalCup" data-i18n="calc.kcalCup">kcal / cup</label>
            <input id="kcalCup" type="number" min="1" step="1" placeholder="—" />
          </div>
          <div>
            <label for="gPerCup" data-i18n="calc.gPerCup">grams / cup</label>
            <input id="gPerCup" type="number" min="1" step="1" placeholder="—" />
          </div>
        </div>

        <p class="hint muted" data-i18n="calc.cupsNote">Cups calculation needs the food energy density (kcal/100g or kcal/cup) and grams per cup (often on the bag). If unknown, rely on grams/day first.</p>
      </fieldset>

      <div style="height:8px"></div>

      <div class="grid">
        <div class="card"><div class="muted">RER</div><div class="mono" id="outRER">—</div></div>
        <div class="card"><div class="muted">MER (kcal/day)</div><div class="mono" id="outMER">—</div></div>
        <div class="card"><div class="muted" data-i18n="calc.grams">Grams/day</div><div class="mono" id="outG" data-est="no">—</div></div>
        <div class="card"><div class="muted" data-i18n="calc.cups">Cups/day</div><div class="mono" id="outCups" data-est="no">—</div></div>
      </div>

      <p class="muted hint" id="estNote" hidden data-i18n="calc.estNote">Values marked (est.) are based on a typical density; use your bag’s numbers for precision.</p>
    </div>

    <details class="footer">
      <summary>Basis & Notes（依据与说明）</summary>
      <div>
        <p><strong>RER</strong> = <code>70 × 体重(kg)^0.75</code>；<strong>MER</strong> = <code>RER × 系数</code>。</p>
        <ul>
          <li><strong>Dog</strong>：低活动/体重管理 1.2–1.4；<strong>已绝育成犬 ~1.6（默认）</strong>；未绝育 ~1.8；活跃/工作 2.0–5.0；幼犬/哺乳更高。</li>
          <li><strong>Cat</strong>：低活动/肥胖倾向 1.0–1.2；<strong>已绝育成猫 ~1.2–1.4（默认 1.3）</strong>；未绝育 ~1.4–1.6；幼猫/哺乳更高。</li>
        </ul>
        <p><strong>7 天渐进换粮</strong>：90/10→80/20→…→10/90。如出现软便/不适，保持当日或倒回一天再继续。</p>
        <p class="muted">WSAVA、AAHA/AAFP、NRC(2006)、FEDIAF 等为参考。以上为一般营养建议，不构成医疗意见。</p>
        <hr/>
        <p><strong>RER</strong> = <code>70 × weight(kg)^0.75</code>; <strong>MER</strong> = <code>RER × factor</code>.</p>
      </div>
    </details>
  </section>

  <!-- 7-DAY -->
  <section id="switch" class="route" hidden>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 data-i18n="switch.title" style="margin:0">7-Day Gradual Switch</h2>
        <div class="row" style="flex:0 0 auto">
          <button id="printBtn" class="primary" data-i18n="ui.print">Export / Print</button>
        </div>
      </div>
      <p class="print-note">Printed from Pet A Plan — <span id="printDate"></span></p>
      <div class="grid" id="switchGrid">
        <div class="card"><strong>Day 1</strong> — 90% current / 10% new</div>
        <div class="card"><strong>Day 2</strong> — 80% / 20%</div>
        <div class="card"><strong>Day 3</strong> — 70% / 30%</div>
        <div class="card"><strong>Day 4</strong> — 60% / 40%</div>
        <div class="card"><strong>Day 5</strong> — 50% / 50%</div>
        <div class="card"><strong>Day 6</strong> — 30% / 70%</div>
        <div class="card"><strong>Day 7</strong> — 10% / 90%</div>
      </div>
      <p class="muted"><strong data-i18n="switch.caution">If stool is soft or pet seems unwell, hold that day or step back one day, then continue after recovery.</strong></p>
    </div>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback" class="route" hidden>
    <div class="card">
      <h2 data-i18n="fb.title">Feedback</h2>
      <p class="muted" data-i18n="fb.note">Choose a category and send us details. No personal health data, please.</p>
      <div class="row">
        <select id="fbCat">
          <option value="calc" data-i18n="fb.opt.calc">Calculator</option>
          <option value="copy" data-i18n="fb.opt.copy">Copy/Basis & Notes</option>
          <option value="switch" data-i18n="fb.opt.switch">7-Day Switch</option>
          <option value="bug" data-i18n="fb.opt.bug">Bug</option>
          <option value="idea" data-i18n="fb.opt.idea">Idea</option>
        </select>
        <button id="fbSend" data-i18n="fb.send">Send mail</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ================== i18n ================== */
const I18N={en:{nav:{home:"Home",calc:"Calc",switch:"7-Day",feedback:"Feedback"},ui:{lang:"Language",print:"Export / Print",reset:"Reset saved"},home:{title:"Feeding & Switch Helper",pitch:"Informational tool for the U.S. market: turn pet food / grooming labels into actionable guidance. Not medical advice.",kcal:"RER/MER transparent",i18n:"Multi-language",quick:"Quick start",q1:"Go to Calc → enter weight → pick species & activity factor.",q2:"Review kcal/day and grams/day. Cups/day requires density info from the bag.",q3:"See 7-Day plan; if stool soft → hold/step back."},calc:{title:"Feeding Calculator",species:"Species",weight:"Weight",lifeStage:"Life stage",activity:"Activity / life stage (MER factor)",factorHint:"Labels show the actual factor used.",infoTip:"Info (i): RER=70×kg^0.75; MER=RER×factor. Adjust by body condition & stool; special stages/diseases: follow your vet.",grams:"Grams/day",cups:"Cups/day",cupsNote:"Cups/day needs kcal density and grams per cup. If unknown, rely on grams/day first.",density:"Optional: density for precise grams/cups",kcal100:"kcal / 100 g",kcalCup:"kcal / cup",gPerCup:"grams / cup",customToggle:"Use custom factor",customHint:"Only change if you know what you’re doing (懂则改，不懂别动)。",estNote:"Values marked (est.) are based on a typical density."},switch:{title:"7-Day Gradual Switch",caution:"If stool is soft or pet seems unwell, hold that day or step back one day, then continue after recovery."},fb:{title:"Feedback",note:"Choose a category and send us details. No personal health data, please.",send:"Send mail",opt:{calc:"Calculator",copy:"Copy/Basis & Notes",switch:"7-Day Switch",bug:"Bug",idea:"Idea"}}},
zh:{nav:{home:"首页",calc:"计算",switch:"7天换粮",feedback:"反馈"},ui:{lang:"语言",print:"导出 / 打印",reset:"恢复默认"},home:{title:"喂养与换粮助手",pitch:"把宠物食品/洗护标签转成可执行建议（非医疗建议）。",kcal:"RER/MER 透明可解释",i18n:"多语言",quick:"快速开始",q1:"进入 计算 → 输入体重 → 选择物种与活动系数。",q2:"查看 kcal/日 与 g/日；杯/日 需包装密度与每杯克数。",q3:"参看 7 天渐进换粮；若便便偏软 → 保持/倒回一天。"},calc:{title:"喂养计算器",species:"物种",weight:"体重",lifeStage:"生命周期",activity:"活动/阶段（MER 系数）",factorHint:"选项名称直接展示所用系数。",infoTip:"提示：RER=70×kg^0.75；MER=RER×系数。应结合体况/便便微调；特殊阶段/疾病遵从兽医。",grams:"克/日",cups:"杯/日",cupsNote:"计算杯数需要食品能量密度与每杯克数；未知则先看 g/日。",density:"可选：用于精算克/杯的密度参数",kcal100:"kcal / 100 g",kcalCup:"kcal / 杯",gPerCup:"克 / 杯",customToggle:"自定义系数",customHint:"懂则改，不懂别动。",estNote:"带 (估) 的数值基于典型密度。"},switch:{title:"7天渐进换粮",caution:"若便便偏软或不适，请保持当日或倒回一天，恢复后再继续。"},fb:{title:"反馈",note:"请选择分类并通过邮件发送问题/建议。请勿提交个人健康信息。",send:"发送邮件",opt:{calc:"计算器",copy:"文案/依据与说明",switch:"7天换粮",bug:"缺陷",idea:"想法"}}},
es:{nav:{home:"Inicio",calc:"Cálculo",switch:"7 días",feedback:"Feedback"},ui:{lang:"Idioma",print:"Exportar / Imprimir",reset:"Restablecer"},calc:{title:"Calculadora",species:"Especie",weight:"Peso",lifeStage:"Etapa de vida",activity:"Actividad / etapa (MER)",factorHint:"Las etiquetas muestran el factor usado.",infoTip:"RER=70×kg^0.75; MER=RER×factor.",grams:"Gramos/día",cups:"Tazas/día",cupsNote:"Las tazas necesitan densidad y gramos por taza.",density:"Opcional: densidad",kcal100:"kcal / 100 g",kcalCup:"kcal / taza",gPerCup:"gramos / taza",customToggle:"Factor personalizado",customHint:"Sólo si sabes lo que haces.",estNote:"(est.) basado en densidad típica."},switch:{title:"Cambio gradual 7 días",caution:"Si hay heces blandas o malestar, mantén el día o retrocede."},fb:{title:"Comentarios",note:"Elige una categoría y envíanos detalles.",send:"Enviar correo",opt:{calc:"Calculadora",copy:"Texto/Notas",switch:"Cambio 7 días",bug:"Error",idea:"Idea"}}},
fr:{nav:{home:"Accueil",calc:"Calcul",switch:"7 jours",feedback:"Avis"},ui:{lang:"Langue",print:"Exporter / Imprimer",reset:"Réinitialiser"},calc:{title:"Calculateur",species:"Espèce",weight:"Poids",lifeStage:"Stade de vie",activity:"Activité / stade (MER)",factorHint:"Les étiquettes affichent le facteur utilisé.",infoTip:"RER=70×kg^0,75 ; MER=RER×facteur.",grams:"Grammes/jour",cups:"Tasses/jour",cupsNote:"Les tasses nécessitent la densité et g/tasse.",density:"Optionnel : densité",kcal100:"kcal / 100 g",kcalCup:"kcal / tasse",gPerCup:"grammes / tasse",customToggle:"Facteur personnalisé",customHint:"Ne changez que si nécessaire.",estNote:"(est.) densité typique."},switch:{title:"Transition 7 jours",caution:"Si selles molles, maintenez ou revenez d'un jour."},fb:{title:"Retour",note:"Choisissez une catégorie et envoyez-nous les détails.",send:"Envoyer un mail",opt:{calc:"Calculateur",copy:"Texte/Notes",switch:"Transition 7 jours",bug:"Anomalie",idea:"Idée"}}}};

/* ================== helpers ================== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const pow075=x=>Math.pow(x,0.75);
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
const isNum=n=>typeof n==='number'&&!Number.isNaN(n)&&Number.isFinite(n);
const KG_PER_LB=0.45359237;

/* ================== router ================== */
function route(){
  const hash=(location.hash||'#home').split('&')[0];
  $$('#home,#calc,#switch,#feedback').forEach(sec=>sec.hidden=true);
  const el=$(hash); if(el) el.hidden=false;
  $$('nav a').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash));
}
window.addEventListener('hashchange',()=>{ route(); pushUrlState() });

/* ================== lang ================== */
function setLang(l){
  const lang=I18N[l]?l:'en';
  localStorage.setItem('lang',lang);
  document.documentElement.lang=lang;
  $('#langSel').value=lang;
  $$('[data-i18n]').forEach(node=>{
    const path=node.getAttribute('data-i18n').split('.');
    let cur=I18N[lang]; for(const k of path){cur=cur?.[k];}
    if(typeof cur==='string') node.textContent=cur;
  });
  // 补充几个独立文本
  $('#resetSavedLink').textContent = I18N[lang].ui.reset;
  $('#printBtn').textContent = I18N[lang].ui.print;
}
function initLang(){
  const params=new URLSearchParams(location.search);
  const ql=params.get('lang') || getUrlKV().lang;
  const saved=localStorage.getItem('lang');
  const lang=ql || saved || 'en';
  setLang(lang);
}
$('#langSel')?.addEventListener('change',e=>{ setLang(e.target.value); pushUrlState(); });

/* ================== factors by stage ================== */
const SAFETY_MIN_FACTOR=0.8, SAFETY_MAX_FACTOR=6.0;
const KCAL_PER_100G_DEFAULT=350;

const STAGE_FACTORS={
  dog:{
    adult:[
      {key:'rest',label:'Resting (1.3)',value:1.3,hint:'low activity / weight mgmt'},
      {key:'normal',label:'Normal (1.6)',value:1.6,hint:'neutered adult (default)'},
      {key:'active',label:'Active (2.0)',value:2.0,hint:'active / working higher'}
    ],
    puppy:[
      {key:'rest',label:'Resting (1.6)',value:1.6,hint:'young baseline'},
      {key:'normal',label:'Normal (2.5)',value:2.5,hint:'typical growth'},
      {key:'active',label:'Active (3.0)',value:3.0,hint:'very active / growth'}
    ],
    senior:[
      {key:'rest',label:'Resting (1.2)',value:1.2,hint:'lower activity'},
      {key:'normal',label:'Normal (1.4)',value:1.4,hint:'senior typical'},
      {key:'active',label:'Active (1.6)',value:1.6,hint:'active senior'}
    ]
  },
  cat:{
    adult:[
      {key:'rest',label:'Resting (1.1)',value:1.1,hint:'low activity'},
      {key:'normal',label:'Normal (1.3)',value:1.3,hint:'neutered adult (default)'},
      {key:'active',label:'Active (1.6)',value:1.6,hint:'active / intact higher'}
    ],
    puppy:[
      {key:'rest',label:'Resting (1.2)',value:1.2,hint:'~0–12 mo'},
      {key:'normal',label:'Normal (1.3)',value:1.3,hint:'~0–12 mo'},
      {key:'active',label:'Active (1.6)',value:1.6,hint:'~0–12 mo'}
    ],
    senior:[
      {key:'rest',label:'Resting (1.1)',value:1.1,hint:'lower activity'},
      {key:'normal',label:'Normal (1.2)',value:1.2,hint:'senior typical'},
      {key:'active',label:'Active (1.3)',value:1.3,hint:'active senior'}
    ]
  }
};

function renderFactors(selectedVal){
  const species=$('#species').value||'dog';
  const stage=$('#lifeStageLbl').value||'adult';
  const defs=STAGE_FACTORS[species]?.[stage]||STAGE_FACTORS.dog.adult;
  const box=$('#factors'); box.innerHTML='';
  defs.forEach((f,i)=>{
    const w=document.createElement('label');
    w.className='label-inline';
    const checked = selectedVal!=null ? (String(selectedVal)===String(f.value)) : (i===1);
    w.innerHTML=`
      <input type="radio" name="factor" value="${f.value}" ${checked?'checked':''} aria-label="${f.label}">
      <span><strong>${f.label}</strong><br/><span class="muted">${f.hint}</span></span>`;
    box.appendChild(w);
  });
}

/* ================== calc ================== */
function currentFactor(){
  const useCustom=$('#useCustom').checked;
  if(useCustom){
    const cf=parseFloat($('#customFactor').value);
    return clamp(isNum(cf)?cf:NaN,SAFETY_MIN_FACTOR,SAFETY_MAX_FACTOR);
  }
  const checked=document.querySelector('input[name="factor"]:checked');
  return parseFloat(checked?.value||'');
}

function readWeightKg(){
  const unit=$('#wUnit').value;
  const v=parseFloat($('#wkg').value);
  if(!(v>0)) return NaN;
  return unit==='lb' ? v*KG_PER_LB : v;
}
function showWeightFromKg(kg){
  const unit=$('#wUnit').value;
  const v = unit==='lb' ? (kg/KG_PER_LB) : kg;
  $('#wkg').value = isNum(v)? (Math.round(v*100)/100) : '';
}

function calc(){
  const kg=readWeightKg();
  const f=currentFactor();
  if(!(kg>0) || !(f>0)){
    $('#outRER').textContent='—'; $('#outMER').textContent='—';
    $('#outG').textContent='—'; $('#outCups').textContent='—';
    $('#estNote').hidden=true; return;
  }
  const RER=70*pow075(kg);
  const factor=clamp(f,SAFETY_MIN_FACTOR,SAFETY_MAX_FACTOR);
  const MER=RER*factor;

  const kcal100=parseFloat($('#kcal100').value);
  const kcalCup=parseFloat($('#kcalCup').value);
  const gPerCup=parseFloat($('#gPerCup').value);

  let est=false; let kcalPerGram;
  if(isNum(kcal100)){ kcalPerGram=kcal100/100; }
  else if(isNum(kcalCup)&&isNum(gPerCup)){ kcalPerGram=kcalCup/gPerCup; }
  else { kcalPerGram=KCAL_PER_100G_DEFAULT/100; est=true; }

  const gramsPerDay=MER/kcalPerGram;
  $('#outRER').textContent=Math.round(RER).toLocaleString();
  $('#outMER').textContent=Math.round(MER).toLocaleString();
  $('#outG').textContent=Math.round(gramsPerDay).toLocaleString()+(est?' (est.)':'');
  let cupsTxt='—';
  if(isNum(gPerCup)){
    const cups=gramsPerDay/gPerCup;
    cupsTxt=(Math.round(cups*100)/100).toLocaleString()+(est?' (est.)':'');
  }
  $('#outCups').textContent=cupsTxt;
  $('#estNote').hidden=!est;

  saveLocal();
  pushUrlState();
}

/* ================== persistence (local + URL) ================== */
const LKEY='p-feed:v1';

function getState(){
  return {
    r: (location.hash||'#home').replace(/^#/,''),
    sp: $('#species').value,
    w: $('#wkg').value,
    u: $('#wUnit').value,
    stage: $('#lifeStageLbl').value,
    usec: $('#useCustom').checked ? 1 : 0,
    cf: $('#customFactor').value,
    f: (document.querySelector('input[name="factor"]:checked')?.value)||'',
    k100: $('#kcal100').value,
    kcup: $('#kcalCup').value,
    gpc: $('#gPerCup').value,
    lang: $('#langSel').value
  };
}
function applyState(s){
  if(s.sp) $('#species').value=s.sp;
  if(s.u) $('#wUnit').value=s.u;
  if(s.w!=null && s.w!=='') $('#wkg').value=s.w;
  if(s.stage) $('#lifeStageLbl').value=s.stage;
  renderFactors(s.usec?null:(s.f||null));
  if(String(s.usec)==='1'){ $('#useCustom').checked=true; $('#customFactor').disabled=false; }
  if(s.cf) $('#customFactor').value=s.cf;
  if(s.k100) $('#kcal100').value=s.k100;
  if(s.kcup) $('#kcalCup').value=s.kcup;
  if(s.gpc) $('#gPerCup').value=s.gpc;
  if(s.lang) setLang(s.lang);
  if(s.r){ location.hash='#'+s.r; route(); }
}

function saveLocal(){
  localStorage.setItem(LKEY, JSON.stringify(getState()));
  $('#resetSaved').style.display='inline-block';
}
function loadLocal(){
  try{
    const s=JSON.parse(localStorage.getItem(LKEY)||'{}');
    return s||{};
  }catch{return {}}
}
function resetSaved(){
  localStorage.removeItem(LKEY);
  const lang=$('#langSel').value;
  location.href = location.pathname+'?v=hotfix-20251006i#calc'; // 让浏览器做一次干净加载
  setLang(lang);
}

/* URL: parse & push */
function getUrlKV(){
  const h=location.hash||'';
  const parts=h.split('&').slice(1);
  const out={};
  parts.forEach(p=>{
    const [k,v]=p.split('=');
    if(k) out[decodeURIComponent(k)]=decodeURIComponent(v||'');
  });
  return out;
}
function buildHashFromState(s){
  const params=[
    ['sp',s.sp],['w',s.w],['u',s.u],
    ['stage',s.stage],
    ['usec',s.usec],['cf',s.cf],['f',s.f],
    ['k100',s.k100],['kcup',s.kcup],['gpc',s.gpc],
    ['lang',s.lang]
  ].filter(([_,v])=>v!=null && String(v)!=='');
  const base='#'+(s.r||'calc');
  if(!params.length) return base;
  return base + '&' + params.map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
}
const debounce=(fn,ms=200)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
const pushUrlState=debounce(()=>{
  const s=getState();
  const h=buildHashFromState(s);
  if(h!==location.hash) history.replaceState(null,'',h);
},150);

/* ================== wiring ================== */
$('#species')?.addEventListener('change',()=>{ renderFactors(); calc(); });
$('#lifeStageLbl')?.addEventListener('change',()=>{ renderFactors(); calc(); });
$('#wkg')?.addEventListener('input',calc);
$('#wUnit')?.addEventListener('change',()=>{ // 单位切换时不改变真实 kg，只重算显示
  const kg=readWeightKg(); if(kg>0) showWeightFromKg(kg);
  calc();
});
document.addEventListener('change',e=>{ if(e.target.name==='factor') calc(); });
['kcal100','kcalCup','gPerCup','customFactor'].forEach(id=>$('#'+id)?.addEventListener('input',calc));
$('#useCustom')?.addEventListener('change',e=>{
  const on=e.target.checked;
  $('#customFactor').disabled=!on;
  if(on){ $$('input[name="factor"]').forEach(r=>r.checked=false); }
  calc();
});
$('#resetSaved')?.addEventListener('click',resetSaved);
$('#resetSavedLink')?.addEventListener('click',resetSaved);

/* feedback */
$('#fbSend')?.addEventListener('click',()=>{
  const cat=$('#fbCat').value;
  const sub=encodeURIComponent(`[Pet A Plan] Feedback: ${cat}`);
  const body=encodeURIComponent(`Context:
- URL: ${location.href}
- Version: ${$('#version').textContent}

Details:
`);
  location.href=`mailto:hello@example.com?subject=${sub}&body=${body}`;
});

/* print */
$('#printBtn')?.addEventListener('click',()=>{
  $('#printDate').textContent=new Date().toLocaleString();
  window.print();
});

/* ================== boot ================== */
(function boot(){
  // 从 URL 恢复（优先）→ 再从 local 恢复
  const kv=getUrlKV();
  const saved=loadLocal();
  // 先给出默认 UI，再套用状态
  renderFactors();
  // 合并优先级：URL > local
  applyState(Object.assign({}, saved, kv));
  if(!location.hash) location.hash='#home';
  route(); initLang(); calc();
})();
</script>

<!--
Changelog
- 2025-10-06 — feature: URL share (hash params) + print (7-Day) + kg/lb toggle; keeps v1.2.3 logic.
-->
</body>
</html>

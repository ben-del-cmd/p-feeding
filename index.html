<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pet Scan</title>

  <!-- 固定为 /p-feeding/，避免相对路径问题 -->
  <base href="/p-feeding/">
  <link rel="stylesheet" href="/p-feeding/assets/site.css?v=20250922" />

  <!-- 主 i18n：如果能加载，就走它；后面还有 fallback 保底 -->
  <script defer src="/p-feeding/i18n.js?v=20250922"></script>
</head>
<body>

  <!-- 顶部导航 -->
  <header class="nav container">
    <a href="./" data-i18n="brand.name">Pet Scan</a>
    <nav>
      <a href="feeding.html" data-i18n="nav.feeding">喂食计算器</a>
      <a href="feedback.html" data-i18n="nav.feedback">反馈</a>
      <a href="cards/" data-i18n="nav.card">7天换粮卡</a>
    </nav>
    <button id="lang-btn">English</button>
  </header>

  <!-- 主体 -->
  <main class="container">
    <h1 data-i18n="home.h1">把难懂的标签 → 变成可执行建议</h1>
    <p class="muted" data-i18n="home.lead">
      扫描/录入宠物食品与洗护信息，统一口径（ME、GA、as-fed/DM），秒出喂量/换粮卡；页面显式来源与时间戳。信息性建议，非医疗。
    </p>

    <section class="cards">
      <article class="card">
        <h3 data-i18n="home.calc.title">① 喂食计算器</h3>
        <p data-i18n="home.calc.desc">RER/MER → kcal/天 → 杯/克；支持混喂与零食占比提示。</p>
        <a class="btn" href="feeding.html" data-i18n="home.calc.btn">打开计算器</a>
      </article>

      <article class="card">
        <h3 data-i18n="home.card.title">② 7 天换粮卡</h3>
        <p data-i18n="home.card.desc">90/10 → 0/100 的过渡表，自动按能量密度换算。</p>
        <a class="btn" href="cards/" data-i18n="home.card.btn">查看换粮卡</a>
      </article>

      <article class="card">
        <h3 data-i18n="home.fb.title">③ 意见反馈</h3>
        <p data-i18n="home.fb.desc">帮助我们提高命中率与解释易读性；导购披露保持中立。</p>
        <a class="btn" href="feedback.html" data-i18n="home.fb.btn">去反馈</a>
      </article>
    </section>

    <p class="muted" style="margin-top:24px">
      <strong data-i18n="footer.noticeTitle">信息性提示（非医疗）</strong>
      <span data-i18n="footer.noticeBody">
        数据可能因配方/包装更新而变化；页面已标注来源/时间戳/版本以供核验。
      </span>
    </p>
  </main>

  <!-- Fallback：若 i18n.js 未成功挂载 __i18n，则二次加载并显式绑定切换事件 -->
  <script>
    (function () {
      var order = ['en','zh','ja','ko','es','fr'];

      function ensureClickBinding() {
        var btn = document.getElementById('lang-btn');
        if (!btn) return;

        // 防止重复绑定
        if (btn.__i18nBound) return;
        btn.__i18nBound = true;

        btn.addEventListener('click', function () {
          try {
            if (window.__i18n && typeof window.__i18n.setLang === 'function') {
              var cur = window.__i18n.lang || 'en';
              var next = order[(order.indexOf(cur) + 1) % order.length];
              window.__i18n.setLang(next);
            } else {
              // 兜底：还没挂上 __i18n，就再尝试加载一次 i18n.js
              var s = document.createElement('script');
              s.src = '/p-feeding/i18n.js?fb=' + Date.now();
              s.defer = true;
              s.onload = function () {
                if (window.__i18n && typeof window.__i18n.setLang === 'function') {
                  var cur2 = window.__i18n.lang || 'en';
                  var next2 = order[(order.indexOf(cur2) + 1) % order.length];
                  window.__i18n.setLang(next2);
                }
              };
              document.head.appendChild(s);
            }
          } catch (e) {
            console.warn('[i18n-fallback] click failed:', e);
          }
        });
      }

      // 若 1 秒内没有出现 __i18n，则主动再拉一次，并保证按钮可用
      function rescueLoad() {
        if (!window.__i18n) {
          var s = document.createElement('script');
          s.src = '/p-feeding/i18n.js?rescue=' + Date.now();
          s.defer = true;
          s.onload = ensureClickBinding;
          document.head.appendChild(s);
        } else {
          ensureClickBinding();
        }
      }

      // 初次就先绑一次；1 秒后做一次自检救援
      document.addEventListener('DOMContentLoaded', function () {
        ensureClickBinding();
        setTimeout(rescueLoad, 1000);
      });
    })();
  </script>
</body>
</html>

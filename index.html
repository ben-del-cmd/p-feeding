<!-- deploy: 2025-10-06 · hotfix-20251006k (kg-lb toggle + keeps per-species×stage memory) -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pet A Plan · Feeding & Switch Helper (v1.2.3 hotfix)</title>
<meta name="description" content="Scan → unify terms → feeding calc → 7-day switch tips. Informational only; not medical advice." />
<meta name="referrer" content="strict-origin-when-cross-origin" />
<meta name="theme-color" content="#0b1220" />
<meta http-equiv="x-ua-compatible" content="IE=edge" />
<link rel="icon" href="data:," />
<style>
:root{--bg:#0b1220;--fg:#e8eefc;--muted:#9fb0d0;--card:#111a2e;--accent:#7aa7ff;--maxw:980px}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--fg)}
a{color:var(--accent)}
.wrap{max-width:var(--maxw);margin:0 auto;padding:16px 20px 80px}
header{position:sticky;top:0;background:linear-gradient(180deg,rgba(11,18,32,.95),rgba(11,18,32,.75));backdrop-filter:saturate(140%) blur(8px);z-index:10;border-bottom:1px solid #1f2b44}
.bar{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:var(--maxw);margin:0 auto;padding:10px 16px}
.brand{display:flex;gap:10px;align-items:center;white-space:nowrap}
.brand .dot{width:10px;height:10px;border-radius:999px;background:var(--accent)}
nav{display:flex;gap:8px;flex:1 1 auto;justify-content:flex-start;flex-wrap:nowrap;min-width:0}
nav a{padding:6px 10px;border-radius:10px;text-decoration:none;border:1px solid #24324f;color:var(--fg);white-space:nowrap}
nav a.active{background:#16213a}
.langbox{flex:0 0 auto;display:flex;align-items:center;gap:8px}
.langbox select{background:#0f1930;border:1px solid #24324f;color:var(--fg);border-radius:10px;padding:8px 10px;min-width:160px}
select,input,button{background:#0f1930;border:1px solid #24324f;color:var(--fg);border-radius:10px;padding:8px 10px}
input[type=number]{width:100%}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
.card{background:var(--card);border:1px solid #1c2740;border-radius:16px;padding:16px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.row > *{flex:1 1 140px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.muted{color:var(--muted)}
.details, details{background:#0f1930;border:1px solid #233355;border-radius:14px;padding:12px}
details > summary{cursor:pointer;font-weight:600}
.kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
.kpi .box{background:#0f1930;border:1px solid #22304a;border-radius:14px;padding:12px}
.footer{opacity:.9;font-size:.9em}
hr{border:none;border-top:1px solid #1f2b44;margin:10px 0}
.hint{font-size:.9em}
.label-inline{display:flex;align-items:center;gap:8px}

/* ===== Scoped form fixes (#calc) ===== */
#calc .form-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(220px, 1fr));
  gap:14px 16px;
  justify-items:start;
  align-items:end;
}
#calc .form-grid > *{display:flex;flex-direction:column;gap:6px;min-width:0}
#calc input,#calc select,#calc textarea{width:min(100%, 360px)}
#calc .factor-row{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px 14px;
}
/* 紧凑左对齐的单选卡片 */
#calc .factor-row .label-inline{
  display:grid;
  grid-template-columns:auto 1fr;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  background:#0f1930;border:1px solid #24324f;border-radius:12px;
}
#calc .factor-row input[type="radio"]{margin:0;transform:translateY(-1px)}
#calc .factor-row .label-inline > span{line-height:1.15}

/* 让体重输入单元布局横排更紧凑 */
#calc .weight-wrap{display:flex;gap:8px;align-items:center;max-width:360px}

/* 7-Day 单列 */
#switch .grid{grid-template-columns:1fr}
@media (min-width:720px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand" aria-label="Pet A Plan">
      <div class="dot"></div>
      <strong>Pet A Plan</strong>
      <span class="muted" id="version">v1.2.3 hotfix</span>
    </div>
    <nav aria-label="Primary">
      <a href="#home" data-i18n="nav.home" class="active">Home</a>
      <a href="#calc" data-i18n="nav.calc">Calc</a>
      <a href="#switch" data-i18n="nav.switch">7-Day</a>
      <a href="#feedback" data-i18n="nav.feedback">Feedback</a>
    </nav>
    <div class="langbox" aria-label="Language">
      <select id="langSel" aria-label="Language">
        <option value="en">English</option>
        <option value="zh">简体中文</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section id="home" class="route">
    <div class="grid">
      <div class="card">
        <h2 data-i18n="home.title">Feeding & Switch Helper</h2>
        <p class="muted" data-i18n="home.pitch">Informational tool for the U.S. market: turn pet food / grooming labels into actionable guidance. Not medical advice.</p>
        <div class="kpi">
          <div class="box">
            <div class="muted" data-i18n="home.kcal">RER/MER transparent</div>
            <div class="mono">RER = 70 × kg^0.75</div>
          </div>
          <div class="box">
            <div class="muted" data-i18n="home.i18n">Multi-language</div>
            <div class="mono">en / zh / es / fr</div>
          </div>
          <div class="box">
            <div class="muted" data-i18n="home.mode">Single-file SPA</div>
            <div class="mono">#home #calc #switch #feedback</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 data-i18n="home.quick">Quick start</h3>
        <ol>
          <li data-i18n="home.q1">Go to Calc → enter weight (kg) → pick species & activity factor.</li>
          <li data-i18n="home.q2">Review kcal/day and grams/day. Cups/day requires density info from the bag.</li>
          <li data-i18n="home.q3">See 7-Day gradual switch plan. If stool soft or upset → hold or step back.</li>
        </ol>
      </div>
    </div>
  </section>

  <!-- CALC -->
  <section id="calc" class="route" hidden>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 data-i18n="calc.title" style="margin:0">Feeding Calculator</h2>
        <a id="resetSaved" href="#" class="muted" style="font-size:.9em;text-decoration:none">Reset saved</a>
      </div>

      <div class="form-grid" style="margin-top:12px">
        <div>
          <label for="species" data-i18n="calc.species">Species</label>
          <select id="species" aria-label="Species">
            <option value="dog">Dog</option>
            <option value="cat">Cat</option>
          </select>
        </div>

        <div>
          <label for="wVal" data-i18n="calc.weight">Weight (kg)</label>
          <div class="weight-wrap">
            <input id="wVal" type="number" min="0" step="0.1" placeholder="10" />
            <select id="wUnit" aria-label="Unit">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
          </div>
        </div>

        <div>
          <label for="lifeStageLbl" data-i18n="calc.lifeStage">Life stage</label>
          <select id="lifeStageLbl">
            <option value="puppy">Puppy / Kitten</option>
            <option value="adult" selected>Adult</option>
            <option value="senior">Senior</option>
          </select>
        </div>
      </div>

      <div style="height:8px"></div>

      <fieldset class="card" style="padding:12px">
        <legend data-i18n="calc.activity">Activity / life stage (MER factor)</legend>
        <div id="factors" class="factor-row" role="radiogroup" aria-label="MER factor"></div>
        <p class="muted" data-i18n="calc.factorHint">Labels show the actual factor used.</p>
        <p class="hint muted" data-i18n="calc.infoTip">Info (i): RER=70×kg^0.75; MER=RER×factor. Factors are a starting point—adjust by body condition & stool; special stages/diseases: follow your vet.</p>

        <div class="row">
          <label class="label-inline"><input type="checkbox" id="useCustom"/> <span data-i18n="calc.customToggle">Use custom factor</span></label>
          <input id="customFactor" type="number" min="0.8" max="6" step="0.1" placeholder="1.6" disabled />
        </div>
        <p class="hint muted" data-i18n="calc.customHint">Only change if you know what you’re doing (懂则改，不懂别动)。</p>
      </fieldset>

      <div style="height:8px"></div>

      <fieldset class="card" style="padding:12px">
        <legend data-i18n="calc.density">Optional: density for precise grams/cups</legend>
        <div class="form-grid">
          <div>
            <label for="kcal100" data-i18n="calc.kcal100">kcal / 100 g</label>
            <input id="kcal100" type="number" min="1" step="1" placeholder="350" />
          </div>
          <div>
            <label for="kcalCup" data-i18n="calc.kcalCup">kcal / cup</label>
            <input id="kcalCup" type="number" min="1" step="1" placeholder="—" />
          </div>
          <div>
            <label for="gPerCup" data-i18n="calc.gPerCup">grams / cup</label>
            <input id="gPerCup" type="number" min="1" step="1" placeholder="—" />
          </div>
        </div>
        <p class="hint muted" data-i18n="calc.cupsNote">Cups calculation needs the food energy density (kcal/100g or kcal/cup) and grams per cup. If unknown, rely on grams/day first.</p>
      </fieldset>

      <div style="height:8px"></div>

      <div class="grid">
        <div class="box card"><div class="muted">RER</div><div class="mono" id="outRER">—</div></div>
        <div class="box card"><div class="muted">MER (kcal/day)</div><div class="mono" id="outMER">—</div></div>
        <div class="box card"><div class="muted" data-i18n="calc.grams">Grams/day</div><div class="mono" id="outG" data-est="no">—</div></div>
        <div class="box card"><div class="muted" data-i18n="calc.cups">Cups/day</div><div class="mono" id="outCups" data-est="no">—</div></div>
      </div>

      <p class="muted hint" id="estNote" hidden data-i18n="calc.estNote">Values marked (est.) are based on a typical density; use your bag’s numbers for precision.</p>
    </div>

    <details class="footer">
      <summary>Basis & Notes（依据与说明）</summary>
      <div>
        <p><strong>RER</strong> = <code>70 × 体重(kg)^0.75</code>；<strong>MER</strong> = <code>RER × 系数</code>。</p>
        <ul>
          <li><strong>Dog</strong>：低活动/体重管理 1.2–1.4；<strong>已绝育成犬 ~1.6（默认）</strong>；未绝育 ~1.8；活跃/工作 2.0–5.0；幼犬/哺乳更高。</li>
          <li><strong>Cat</strong>：低活动/肥胖倾向 1.0–1.2；<strong>已绝育成猫 ~1.2–1.4（默认 1.3）</strong>；未绝育 ~1.4–1.6；幼猫/哺乳更高。</li>
        </ul>
        <p><strong>7 天渐进换粮</strong>：90/10→80/20→…→10/90。如出现软便/不适，保持当日或倒回一天再继续。</p>
        <p class="muted">WSAVA、AAHA/AAFP、NRC(2006)、FEDIAF…</p>
        <hr/>
        <p><strong>RER</strong> = <code>70 × weight(kg)^0.75</code>; <strong>MER</strong> = <code>RER × factor</code>.</p>
        <ul>
          <li><strong>Dog</strong>: neutered adult ~1.6 (default)…</li>
          <li><strong>Cat</strong>: neutered adult ~1.3 (1.2–1.4)…</li>
        </ul>
        <p><strong>7-day gradual switch</strong>: 90/10 → … → 10/90…</p>
      </div>
    </details>
  </section>

  <!-- 7-DAY -->
  <section id="switch" class="route" hidden>
    <div class="card">
      <h2 data-i18n="switch.title">7-Day Gradual Switch</h2>
      <div class="grid">
        <div class="card"><strong>Day 1</strong> — 90% current / 10% new</div>
        <div class="card"><strong>Day 2</strong> — 80% / 20%</div>
        <div class="card"><strong>Day 3</strong> — 70% / 30%</div>
        <div class="card"><strong>Day 4</strong> — 60% / 40%</div>
        <div class="card"><strong>Day 5</strong> — 50% / 50%</div>
        <div class="card"><strong>Day 6</strong> — 30% / 70%</div>
        <div class="card"><strong>Day 7</strong> — 10% / 90%</div>
      </div>
      <p class="muted"><strong data-i18n="switch.caution">If stool is soft or pet seems unwell, hold that day or step back one day, then continue after recovery.</strong></p>
    </div>
  </section>

  <!-- FEEDBACK -->
  <section id="feedback" class="route" hidden>
    <div class="card">
      <h2 data-i18n="fb.title">Feedback</h2>
      <p class="muted" data-i18n="fb.note">Choose a category and send us details. No personal health data, please.</p>
      <div class="row">
        <select id="fbCat">
          <option value="calc" data-i18n="fb.opt.calc">Calculator</option>
          <option value="copy" data-i18n="fb.opt.copy">Copy/Basis & Notes</option>
          <option value="switch" data-i18n="fb.opt.switch">7-Day Switch</option>
          <option value="bug" data-i18n="fb.opt.bug">Bug</option>
          <option value="idea" data-i18n="fb.opt.idea">Idea</option>
        </select>
        <button id="fbSend" data-i18n="fb.send">Send mail</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ---------- I18N（与之前版本一致，略去部分重复文本以节省体积） ---------- */
const I18N={en:{nav:{home:"Home",calc:"Calc",switch:"7-Day",feedback:"Feedback"},ui:{lang:"Language"},home:{title:"Feeding & Switch Helper",pitch:"Informational tool for the U.S. market: turn pet food / grooming labels into actionable guidance. Not medical advice.",kcal:"RER/MER transparent",i18n:"Multi-language",mode:"Single-file SPA",quick:"Quick start",q1:"Go to Calc → enter weight (kg) → pick species & activity factor.",q2:"Review kcal/day and grams/day. Cups/day requires density info from the bag.",q3:"See 7-Day gradual switch plan. If stool soft or upset → hold or step back."},calc:{title:"Feeding Calculator",species:"Species",weight:"Weight (kg)",lifeStage:"Life stage",activity:"Activity / life stage (MER factor)",factorHint:"Labels show the actual factor used.",infoTip:"Info (i): RER=70×kg^0.75; MER=RER×factor. Factors are a starting point—adjust by body condition & stool; special stages/diseases: follow your vet.",grams:"Grams/day",cups:"Cups/day",cupsNote:"Cups calculation needs the food energy density (kcal/100g or kcal/cup) and grams per cup. If unknown, rely on grams/day first.",density:"Optional: density for precise grams/cups",kcal100:"kcal / 100 g",kcalCup:"kcal / cup",gPerCup:"grams / cup",customToggle:"Use custom factor",customHint:"Only change if you know what you’re doing (懂则改，不懂别动)。",estNote:"Values marked (est.) are based on a typical density; use your bag’s numbers for precision."},switch:{title:"7-Day Gradual Switch",caution:"If stool is soft or pet seems unwell, hold that day or step back one day, then continue after recovery."},fb:{title:"Feedback",note:"Choose a category and send us details. No personal health data, please.",send:"Send mail",opt:{calc:"Calculator",copy:"Copy/Basis & Notes",switch:"7-Day Switch",bug:"Bug",idea:"Idea"}}},zh:{nav:{home:"首页",calc:"计算",switch:"7天换粮",feedback:"反馈"},ui:{lang:"语言"},home:{title:"喂养与换粮助手",pitch:"面向美国市场的信息性工具：把宠物食品/洗护标签转成可执行建议。非医疗建议。",kcal:"RER/MER 透明可解释",i18n:"多语言",mode:"单文件 SPA",quick:"快速开始",q1:"进入 计算 → 输入体重(kg) → 选择物种与活动系数。",q2:"查看 kcal/日 与 g/日。Cups/日 需要包装上的能量密度与每杯克数。",q3:"查看 7 天渐进换粮。如便便偏软或不适 → 保持当日或倒回一天。"},calc:{title:"喂养计算器",species:"物种",weight:"体重(kg)",lifeStage:"生命周期",activity:"活动/阶段（MER 系数）",factorHint:"选项名称直接展示所用系数。",infoTip:"提示（i）：RER=70×kg^0.75；MER=RER×系数。系数仅为起点，应结合体况/便便微调；特殊阶段/疾病遵从兽医。",grams:"克/日",cups:"杯/日",cupsNote:"计算杯数需要食品能量密度（kcal/100g 或 kcal/cup）与每杯克数；若未知，请先以 g/日 为准。",density:"可选：用于精算克/杯的密度参数",kcal100:"kcal / 100 g",kcalCup:"kcal / 杯",gPerCup:"克 / 杯",customToggle:"自定义系数",customHint:"懂则改，不懂别动。",estNote:"标注 (估) 的数值基于典型密度；使用包装标注可获得更精确结果。"},switch:{title:"7天渐进换粮",caution:"若便便偏软或不适，请保持当日或倒回一天，恢复后再继续。"},fb:{title:"反馈",note:"请选择分类并通过邮件发送问题/建议。请勿提交个人健康信息。",send:"发送邮件",opt:{calc:"计算器",copy:"文案/依据与说明",switch:"7天换粮",bug:"缺陷",idea:"想法"}}},es:{nav:{home:"Inicio",calc:"Cálculo",switch:"7 días",feedback:"Feedback"}},fr:{nav:{home:"Accueil",calc:"Calcul",switch:"7 jours",feedback:"Avis"}}};

/* ---------- 因子文案映射（同上） ---------- */
const FACTOR_TEXT = {
  en:{rest:'Resting',normal:'Normal',active:'Active',hints:{
    dog:{adult:{rest:'low activity / weight mgmt',normal:'neutered adult (default)',active:'active / working higher'},
         puppy:{rest:'young baseline',normal:'typical growth',active:'very active / growth'},
         senior:{rest:'lower activity',normal:'senior typical',active:'active senior'}},
    cat:{adult:{rest:'low activity',normal:'neutered adult (default)',active:'active / intact higher'},
         puppy:{rest:'~0–12 mo',normal:'~0–12 mo',active:'~0–12 mo'},
         senior:{rest:'lower activity',normal:'senior typical',active:'active senior'}}}},
  zh:{rest:'静止',normal:'正常',active:'活跃',hints:{
    dog:{adult:{rest:'低活动/体重管理',normal:'已绝育成犬（默认）',active:'活跃/工作更高'},
         puppy:{rest:'幼年基线',normal:'典型生长',active:'非常活跃/生长'},
         senior:{rest:'低活动',normal:'老年典型',active:'活跃老年'}},
    cat:{adult:{rest:'低活动',normal:'已绝育成猫（默认）',active:'活跃/未绝育更高'},
         puppy:{rest:'~0–12 月龄',normal:'~0–12 月龄',active:'~0–12 月龄'},
         senior:{rest:'低活动',normal:'老年典型',active:'活跃老年'}}}},
  es:{rest:'Reposo',normal:'Normal',active:'Activo',hints:{}},
  fr:{rest:'Repos',normal:'Normal',active:'Actif',hints:{}}
};

/* ---------- helpers ---------- */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const load=(k,d=null)=>{try{const v=localStorage.getItem(k);return v==null?d:JSON.parse(v);}catch{return d;}};

/* 体重单位换算 */
const LB_PER_KG = 2.20462262185;

/* 分组因子存储 key */
function factorKey(){
  const sp=$('#species')?.value||'dog';
  const st=$('#lifeStageLbl')?.value||'adult';
  return `factor_${sp}_${st}`;
}

/* 路由 */
function route(){
  const hash=(location.hash||'#home').split('&')[0];
  $$('#home,#calc,#switch,#feedback').forEach(s=>s.hidden=true);
  const el=$(hash); if(el) el.hidden=false;
  $$('nav a').forEach(a=>a.classList.toggle('active',a.getAttribute('href')===hash));
}
window.addEventListener('hashchange',route);

/* 语言 */
function setLang(l){
  const lang=I18N[l]?l:'en';
  save('lang',lang);
  document.documentElement.lang=lang;
  $$('[data-i18n]').forEach(node=>{
    const path=node.getAttribute('data-i18n').split('.');
    let cur=I18N[lang]; for(const k of path){cur=cur?.[k];}
    if(typeof cur==='string') node.textContent=cur;
  });
  renderFactors(); calc();
}
function initLang(){
  const ql=new URLSearchParams(location.search).get('lang');
  const saved=load('lang',null);
  const lang=ql||saved||'en';
  $('#langSel').value=I18N[lang]?lang:'en';
  setLang($('#langSel').value);
}
$('#langSel')?.addEventListener('change',e=>setLang(e.target.value));

/* 因子定义 */
const SAFETY_MIN_FACTOR=0.8, SAFETY_MAX_FACTOR=6.0;
const KCAL_PER_100G_DEFAULT=350;

const STAGE_FACTORS={
  dog:{adult:[{key:'rest',value:1.3},{key:'normal',value:1.6},{key:'active',value:2.0}],
       puppy:[{key:'rest',value:1.6},{key:'normal',value:2.5},{key:'active',value:3.0}],
       senior:[{key:'rest',value:1.2},{key:'normal',value:1.4},{key:'active',value:1.6}]},
  cat:{adult:[{key:'rest',value:1.1},{key:'normal',value:1.3},{key:'active',value:1.6}],
       puppy:[{key:'rest',value:1.2},{key:'normal',value:1.3},{key:'active',value:1.6}],
       senior:[{key:'rest',value:1.1},{key:'normal',value:1.2},{key:'active',value:1.3}]}
};

/* 渲染因子卡片（含本地化 & 分组记忆） */
function renderFactors(){
  const lang=load('lang','en');
  const L=FACTOR_TEXT[lang]||FACTOR_TEXT.en;

  const species=$('#species').value||'dog';
  const stage=$('#lifeStageLbl').value||'adult';
  const defs=STAGE_FACTORS[species]?.[stage]||STAGE_FACTORS.dog.adult;
  const box=$('#factors'); box.innerHTML='';

  const H=(L.hints&&L.hints[species]&&L.hints[species][stage])?L.hints[species][stage]:{};

  defs.forEach(f=>{
    const name=L[f.key]||f.key; const hint=H[f.key]||'';
    const label=`${name} (${f.value})`;
    const w=document.createElement('label');
    w.className='label-inline';
    w.innerHTML=`
      <input type="radio" name="factor" value="${f.value}" aria-label="${label}">
      <span><strong>${label}</strong><br/><span class="muted">${hint}</span></span>`;
    box.appendChild(w);
  });

  // 分组记忆
  const grouped=load(factorKey(),null);
  const radios=$$('input[name="factor"]',box);
  let checked=false;
  if(grouped!=null){
    for(const r of radios){ if(parseFloat(r.value)===parseFloat(grouped)){ r.checked=true; checked=true; break; } }
  }
  if(!checked && radios[1]) radios[1].checked=true; // 默认第二项
}

/* 体重（kg）读取：把当前输入按单位换算为 kg */
function getWeightKg(){
  const v=parseFloat($('#wVal').value);
  const unit=$('#wUnit').value;
  if(!(v>0)) return NaN;
  return unit==='kg' ? v : v / LB_PER_KG;
}

/* 计算 */
const pow075=x=>Math.pow(x,0.75);
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
const isNum=n=>typeof n==='number'&&!Number.isNaN(n)&&Number.isFinite(n);

function calc(){
  const kg=getWeightKg();
  const f=currentFactor();
  if(!(kg>0) || !(f>0)){
    $('#outRER').textContent='—'; $('#outMER').textContent='—';
    $('#outG').textContent='—'; $('#outCups').textContent='—';
    $('#estNote').hidden=true; return;
  }
  const RER=70*pow075(kg);
  const factor=clamp(f,SAFETY_MIN_FACTOR,SAFETY_MAX_FACTOR);
  const MER=RER*factor;

  const kcal100=parseFloat($('#kcal100').value);
  const kcalCup=parseFloat($('#kcalCup').value);
  const gPerCup=parseFloat($('#gPerCup').value);

  let est=false; let kcalPerGram;
  if(isNum(kcal100)){ kcalPerGram=kcal100/100; }
  else if(isNum(kcalCup)&&isNum(gPerCup)){ kcalPerGram=kcalCup/gPerCup; }
  else { kcalPerGram=KCAL_PER_100G_DEFAULT/100; est=true; }

  const gramsPerDay=MER/kcalPerGram;
  $('#outRER').textContent=Math.round(RER).toLocaleString();
  $('#outMER').textContent=Math.round(MER).toLocaleString();
  $('#outG').textContent=Math.round(gramsPerDay).toLocaleString()+(est?' (est.)':'');
  let cupsTxt='—';
  if(isNum(gPerCup)){
    const cups=gramsPerDay/gPerCup;
    cupsTxt=(Math.round(cups*100)/100).toLocaleString()+(est?' (est.)':'');
  }
  $('#outCups').textContent=cupsTxt;
  $('#estNote').hidden=!est;
}

function currentFactor(){
  const useCustom=$('#useCustom').checked;
  if(useCustom){
    const cf=parseFloat($('#customFactor').value);
    return clamp(isNum(cf)?cf:NaN,SAFETY_MIN_FACTOR,SAFETY_MAX_FACTOR);
  }
  const checked=document.querySelector('input[name="factor"]:checked');
  return parseFloat(checked?.value||'');
}

/* 绑定 + 恢复 */
function wireAndRestore(){
  // 恢复基础字段
  $('#species').value=load('species','dog');
  $('#lifeStageLbl').value=load('lifeStageLbl','adult');

  // 体重与单位
  $('#wUnit').value=load('wUnit','kg');
  const savedVal=load('wVal','');
  if(savedVal!=='') $('#wVal').value=savedVal;

  renderFactors();

  const useCustom=!!load('useCustom',false); $('#useCustom').checked=useCustom;
  $('#customFactor').disabled=!useCustom;
  const cfv=load('customFactor',''); if(cfv!=='') $('#customFactor').value=cfv;
  const kcal100=load('kcal100',''); if(kcal100!=='') $('#kcal100').value=kcal100;
  const kcalCup=load('kcalCup',''); if(kcalCup!=='') $('#kcalCup').value=kcalCup;
  const gPerCup=load('gPerCup',''); if(gPerCup!=='') $('#gPerCup').value=gPerCup;

  // 事件：保存 & 计算
  $('#species')?.addEventListener('change',e=>{ save('species',e.target.value); renderFactors(); calc(); });
  $('#lifeStageLbl')?.addEventListener('change',e=>{ save('lifeStageLbl',e.target.value); renderFactors(); calc(); });

  $('#wVal')?.addEventListener('input',e=>{ save('wVal',e.target.value); calc(); });

  // 切换单位：把显示值做等值换算，再保存
  $('#wUnit')?.addEventListener('change',e=>{
    const oldUnit=load('wUnit','kg');
    const newUnit=e.target.value;
    let v=parseFloat($('#wVal').value);
    if(v>0 && oldUnit!==newUnit){
      if(newUnit==='lb') v = v*LB_PER_KG; else v = v/LB_PER_KG;
      // 保留 2 位小数，避免看起来“跳变”太大
      $('#wVal').value = (Math.round(v*100)/100).toString();
      save('wVal',$('#wVal').value);
    }
    save('wUnit',newUnit);
    calc();
  });

  document.addEventListener('change',e=>{
    if(e.target.name==='factor'){
      const val=parseFloat(e.target.value);
      save(factorKey(),val); // 分组保存
      save('factor',val);    // 兼容旧键
      calc();
    }
  });

  ['kcal100','kcalCup','gPerCup','customFactor'].forEach(id=>{
    $('#'+id)?.addEventListener('input',e=>{ save(id,e.target.value); calc(); });
  });

  $('#useCustom')?.addEventListener('change',e=>{
    const on=e.target.checked; save('useCustom',on);
    $('#customFactor').disabled=!on;
    if(!on){
      const checked=document.querySelector('input[name="factor"]:checked');
      if(!checked){
        const radios=$$('input[name="factor"]');
        if(radios[1]){ radios[1].checked=true; const v=parseFloat(radios[1].value); save(factorKey(),v); save('factor',v); }
      }
    }
    calc();
  });

  // Reset：清空所有保存（含 factor_ 前缀）
  $('#resetSaved')?.addEventListener('click',(e)=>{
    e.preventDefault();
    try{ Object.keys(localStorage).forEach(k=>{ if(/^factor_/.test(k)) localStorage.removeItem(k); }); }catch{}
    ['species','lifeStageLbl','wVal','wUnit','factor','kcal100','kcalCup','gPerCup','useCustom','customFactor','lang']
      .forEach(k=>{ try{localStorage.removeItem(k);}catch{} });
    // 恢复默认
    $('#species').value='dog';
    $('#lifeStageLbl').value='adult';
    $('#wUnit').value='kg';
    $('#wVal').value='';
    $('#kcal100').value=''; $('#kcalCup').value=''; $('#gPerCup').value='';
    $('#useCustom').checked=false; $('#customFactor').value=''; $('#customFactor').disabled=true;
    renderFactors(); calc();
  });

  calc();
}

/* 反馈 */
$('#fbSend')?.addEventListener('click',()=>{
  const cat=$('#fbCat').value;
  const sub=encodeURIComponent(`[Pet A Plan] Feedback: ${cat}`);
  const body=encodeURIComponent(`Context:
- URL: ${location.href}
- Version: ${$('#version').textContent}

Details:
`);
  location.href=`mailto:hello@example.com?subject=${sub}&body=${body}`;
});

/* boot */
(function boot(){
  if(!location.hash) location.hash='#home';
  route();
  initLang();
  wireAndRestore();
})();
</script>

<!--
DOC_SYNC_INDEX.md (append)
- 2025-10-06 — hotfix-20251006k: add kg↔lb toggle; remember unit & value; keep per-species×stage factor memory; reset clears all.
-->
</body>
</html>
